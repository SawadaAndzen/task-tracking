{% extends "app/base.html" %}
{% load static %}

{% block title %}
    <title>NovaTask • {{task.name}} • Details</title>
{% endblock title %}

{% block content %}
    <h1>{{task.name}}</h1>
    <p>Desc: {{task.description}}</p>
    <p>Status: {{task.get_status_display}}</p>
    <p>Priority: {{task.get_priority_display}}</p>
    <p>Deadline: {{task.deadline}}</p>

    <div class="row d-flex justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-0 border" style="background-color: #f0f2f5;">
                <div class="card-body p-4">
                    {% for comment in comments %}
                        <div class="card mb-2">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <p>{{comment.content}}</p>
                                </div>
                                <div class="d-flex flex-row align-items-center justify-content-start">
                                    <img class="rounded-5" src="{% static "best-profile-picture.jpg" %}" alt="avatar" width="32" height="32" />
                                    <p class="small mb-0 ms-2">{{comment.author.first_name}} {{comment.author.second_name}}</p>
                                    <p class="small mb-0 ms-2 text-secondary">{{comment.created_at}}</p>

                                    {% if comment.author == current_user %}
                                        <a class="bi bi-pencil ms-2 me-2" href="{% url "comment-update" comment.pk %}"></a>
                                        <a class="bi bi-trash me-2" href="{% url "comment-delete" comment.pk %}"></a>
                                    {% endif %}
                                    
                                    <div class="d-flex align-items-center ms-auto">
                                        {% if user.is_authenticated %}
                                            <a class="like-button" data-comment-id="{{ comment.id }}">
                                                {% if user in comment.likes.all %}
                                                    <i class="bi bi-hand-thumbs-up-fill"></i>
                                                {% else %}
                                                    <i class="bi bi-hand-thumbs-up"></i>
                                                {% endif %}
                                            </a>
                                        {% endif %}
                                        <p class="mb-0 ms-2"><span id="like-count-{{ comment.id }}">{{ comment.likes.count }}</span></p>
                                    </div>                                    
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    <form method="POST" class="d-flex align-items-center">
                        {% csrf_token %}
                        <div class="flex-grow-1 me-2">
                            {{ comments_form.as_p }}
                        </div>
                        <div>
                            {% if user.is_authenticated %}
                                <button class="btn btn-primary" type="submit"><i class="bi bi-send"></i></button>
                            {% else %}
                                <button class="btn btn-primary" type="submit" disabled><i class="bi bi-send"></i></button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.querySelectorAll('.like-button').forEach(button => {
            button.addEventListener('click', async function () {
                const commentId = this.getAttribute('data-comment-id');
                
                // Send an AJAX request to the like endpoint
                const response = await fetch(`/comments/${commentId}/like/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}', // Make sure CSRF token is available
                    },
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const liked = data.liked;
                    const totalLikes = data.total_likes;
    
                    // Toggle the icon (simplified example)
                    const icon = this.querySelector('i');
                    if (liked) {
                        icon.classList.replace('bi-hand-thumbs-up', 'bi-hand-thumbs-up-fill');
                    } else {
                        icon.classList.replace('bi-hand-thumbs-up-fill', 'bi-hand-thumbs-up');
                    }
    
                    // Update the like count in the DOM
                    const likeCountElement = document.getElementById(`like-count-${commentId}`);
                    if (likeCountElement) {
                        likeCountElement.textContent = totalLikes;
                    }
                } else {
                    console.error('Failed to toggle like status');
                }
            });
        });
    </script>
    

{% endblock content %}